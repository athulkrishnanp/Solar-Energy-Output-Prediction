# -*- coding: utf-8 -*-
"""solarenergypredictionipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1qmP7hoqb7xJlNu_x82b4gX99vnIIul8m
"""

# ===============================================================
# 1️⃣ Import Libraries
# ===============================================================
import pandas as pd
from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestClassifier
from sklearn.metrics import accuracy_score, classification_report
import numpy as np

# ===============================================================
# 2️⃣ Load Data
# ===============================================================
df = pd.read_csv('/content/spg.csv')

# ===============================================================
# 3️⃣ Features
# ===============================================================
features = [
    'temperature_2_m_above_gnd',
    'relative_humidity_2_m_above_gnd',
    'shortwave_radiation_backwards_sfc',
    'total_cloud_cover_sfc',
    'wind_speed_10_m_above_gnd',
    'angle_of_incidence',
    'zenith',
    'azimuth'
]

# ===============================================================
# 4️⃣ Create 4 Classes from Generated Power
# ===============================================================

def classify_power(value):
    if value < 150:
        return 0
    elif value < 500:
        return 1
    elif value < 1000:
        return 2
    else:
        return 3

df["power_class"] = df["generated_power_kw"].apply(classify_power)

# X and y
X = df[features]
y = df["power_class"]

# ===============================================================
# 5️⃣ Handle missing values
# ===============================================================
X = X.fillna(X.mean())

# ===============================================================
# 6️⃣ Train-Test Split
# ===============================================================
X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=0.2, random_state=42
)

# ===============================================================
# 7️⃣ Train Random Forest Classifier
# ===============================================================
model = RandomForestClassifier(
    n_estimators=200,
    random_state=42
)
model.fit(X_train, y_train)

# ===============================================================
# 8️⃣ Predictions and Evaluation
# ===============================================================
y_pred = model.predict(X_test)

print("Accuracy:", accuracy_score(y_test, y_pred))
print("\nClassification Report:\n")
print(classification_report(y_test, y_pred))

# ===============================================================
# 9️⃣ Predict for new input
# ===============================================================
new_input = pd.DataFrame([{
    'temperature_2_m_above_gnd': 2.17,
    'relative_humidity_2_m_above_gnd': 31,
    'shortwave_radiation_backwards_sfc': 0,
    'total_cloud_cover_sfc': 0,
    'wind_speed_10_m_above_gnd': 6.37,
    'angle_of_incidence': 58.753108,
    'zenith': 83.237322,
    'azimuth': 128.33543
}])

predicted_class = model.predict(new_input)[0]

labels = {
    0: "Very Low Power",
    1: "Low Power",
    2: "Medium Power",
    3: "High / Peak Power"
}

print(f"\nPredicted Class: {predicted_class} → {labels[predicted_class]}")

import pickle

# Save the model
with open("solar_model.pkl", "wb") as f:
    pickle.dump(model, f)

print("Model saved as solar_model.pkl")